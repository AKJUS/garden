name: Publish Garden release

on:
  release:
    # The workflow will run once the release has been published (i.e. is not in draft state anymore)
    # and it will only run if it is not a pre-release. See https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#release
    types: [released]
  repository_dispatch:
    # Triggered by post-release.yml after publishing a draft release.
    # GITHUB_TOKEN events don't trigger release-based workflows, but
    # repository_dispatch is an exception to this rule.
    types: [publish-release]

permissions:
  contents: read

env:
  # Normalize the release version across trigger types:
  RELEASE_VERSION: ${{ github.event.release.tag_name || github.event.client_payload.tag-name }}

jobs:
  release-homebrew:
    uses: ./.github/workflows/reusable-create-homebrew-pr.yml
    with:
      release-version: ${{ github.event.release.tag_name || github.event.client_payload.tag-name }}
      commit-message: |
        This PR has been generated by the publish-release workflow after the new release

        @${{ github.triggering_actor }} Please review this PR carefully and merge once Garden should be released to Homebrew.
    secrets: inherit
